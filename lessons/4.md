# Testando a funcionalidade de cria√ß√£o de projeto

Nesta aula, teu desafio √© testar o cen√°rio de cria√ß√£o de projeto com sucesso.

## Exerc√≠cio 1 - Cria√ß√£o de projeto

Crie um teste automatizado que exercita a funcionalidade de cria√ß√£o de projeto via interface gr√°fica de usu√°rio.

<details><summary>Em caso de d√∫vidas, abra para ver o passo-a-passo</summary>
</br>

1. Dentro do diretr√≥rio `cypress/e2e/gui/`, crie um arquivo chamado `createProject.cy.js` com os seguintes dados:

```js
import { faker } from '@faker-js/faker'

describe('Create Project', () => {
  beforeEach(() => {
    cy.login()
  })

  it('successfully', () => {
    const project = {
      name: `project-${faker.datatype.uuid()}`,
      description: faker.random.words(5)
    }

    cy.gui_createProject(project)

    cy.url().should('be.equal', `${Cypress.config('baseUrl')}/${Cypress.env('user_name')}/${project.name}`)
    cy.contains(project.name).should('be.visible')
    cy.contains(project.description).should('be.visible')
  })
})

```

2. Dentro do diret√≥rio `cypress/support/`, atualize o arquivo `gui_commands.js` com o commando `gui_createProject`, conforme abaixo:

```js
Cypress.Commands.add('login', () => {
  ...
})

Cypress.Commands.add('logout', () => {
  ...
})

Cypress.Commands.add('gui_createProject', project => {
  cy.visit('/projects/new')

  cy.get('#project_name').type(project.name)
  cy.get('#project_description').type(project.description)
  cy.get('.qa-initialize-with-readme-checkbox').check()
  cy.contains('Create project').click()
})

```

3. Por fim, no terminal de linha de comando, na raiz do projeto, execute o comando `npx cypress run --spec cypress/e2e/gui/createProject.cy.js` para executar o novo teste em modo _headless_.

Ao final da execu√ß√£o, voc√™ deve possuir um resultado como o seguinte:

```
(Run Finished)


       Spec                                              Tests  Passing  Failing  Pending  Skipped
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ ‚úî  createProject.cy.js                      00:06        1        1        -        -        - ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚úî  All specs passed!                        00:06        1        1        -        -        -

```

> Eba! A cria√ß√£o de projetos tamb√©m est√° coberta por testes!

</details>

## Exerc√≠cio 2 - Modo interativo

Execute o novo teste em mode interativo e tente descobrir se alguma parte do mesmo poderia ser otimizada.

<details><summary>Em caso de d√∫vidas, abra para ver o passo-a-passo</summary>
</br>

1. No terminal de linha de comando, na raiz do projeto, execute o comando `npx cypress open` para abrir a Cypress App
2. Selecione a op√ß√£o _E2E Testing_ e inicialize o navegador Electron
3. Clique no arquivo `createProject.cy.js` e veja-o executando em modo interativo.

> üë®‚Äçüè´ Perceba que al√©m da cria√ß√£o do projeto, o _login_ tamb√©m ocorre via _GUI_.
>
> Isso √© um desperd√≠cio, visto que j√° temos um teste para a funcionalidade de _login_.
>
> O mesmo vale para o teste de _logout_, onde o usu√°rio estar autenticado √© s√≥ uma pr√©-condi√ß√£o.

</details>

### Exerc√≠cio 3 - Salvando a sess√£o do usu√°rio

Fa√ßa uso da funcionalidade [`cy.session()`](https://docs.cypress.io/api/commands/session) para salvar a sess√£o do usu√°rio no navegador, e assim, otimizar o testes, fazendo _login_ via _GUI_ somente para o teste que faz sentido.

<details><summary>Em caso de d√∫vidas, abra para ver o passo-a-passo</summary>
</br>

1. No arquivo `cypress/support/gui_commands.js`, altere o comando customizado de _login_ pelo seguinte:

```js
Cypress.Commands.add('login', (
  user = Cypress.env('user_name'),
  password = Cypress.env('user_password'),
  { cacheSession = true } = {},
) => {
  const login = () => {
    cy.visit('/users/sign_in')

    cy.get("[data-qa-selector='login_field']").type(user)
    cy.get("[data-qa-selector='password_field']").type(password, { log: false })
    cy.get("[data-qa-selector='sign_in_button']").click()
  }

  const options = {
    cacheAcrossSpecs: true,
  }

  if (cacheSession) {
    cy.session(user, login, options)
  } else {
    login()
  }
})

Cypress.Commands.add('logout', () => {
  ...
})

Cypress.Commands.add('gui_createProject', () => {
  ...
})

```

 > üë®‚Äçüè´ Agora, o Cypress est√° configurado para criar (e restaurar) a sess√£o do usu√°rio, salvando tempo para testes em que isso √© s√≥ uma pr√©-condi√ß√£o, al√©m de continuar possibilitando o _login_ via _GUI_, quando este ainda for o foco do mesmo, tal como no teste de _login_ propriamente dito.
>
> Al√©m disso, a nova vers√£o do comando de _login_ est√° preparada para compartilhar a sess√£o entre _specs_ (arquivos de teste).

2. No arquivo `cypress/e2e/gui/login.cy.js`, altere seu conte√∫do para o seguinte:

```js
describe('Login', () => {
  it('successfully', () => {
    const user = Cypress.env('user_name')
    const password = Cypress.env('user_password')
    const options = { cacheSession: false }

    cy.login(user, password, options)

    cy.get('.qa-user-avatar').should('be.visible')
  })
})

```

3. Por fim, **feche a Cypress App**, abra-a de novo (`npx cypress open`) e execute o seguintes testes, nesta exata ordem: `createProject.cy.js`, `createProject.cy.js` (isso mesmo, 2x) e `logout.cy.js`.

> üë®‚Äçüè´ Perceba que na segunda execu√ß√£o do teste de cria√ß√£o de projeto e no teste de _logout_, o usu√°rio j√° estava autenticado e os testes focaram s√≥ no que lhes interessava, s√≥ no que era seu "alvo".

</details>

### Exerc√≠cio 4 - Validando a sess√£o

Se voc√™ executar novamente o teste `createProject.cy.js` ap√≥s ter implementado o uso da funcionalidade `cy.session()`, perceber√° que, se o teste de _logout_ for executado antes, a sess√£o ser√° perdida e teremos um erro.

Isso ocorre pois o teste de _logout_ invalida a sess√£o.

Teu exerc√≠cio √© atualizar o comando customizado de login de forma que, em caso da sess√£o ser invalidada, o _login_ deve ocorrer de novo via _GUI_ para criar uma nova sess√£o.

<details><summary>Em caso de d√∫vidas, abra para ver o passo-a-passo</summary>
</br>

1. Ainda via Cypress App, execute de novo o arquivo `createProject.cy.js`

> üí• U√©? O Cypress tentou restaurar a sess√£o, mas n√£o conseguiu.
>
> üë®‚Äçüè´ Isso √© devido ao teste de _logout_ estar destruindo a sess√£o, visto que este √© o essencial prop√≥sito da funcionalidade.
>
> Por√©m, podemos verificar se a sess√£o ainda est√° v√°lida, e se n√£o estiver, cri√°-la de novo (nem que seja via _GUI_). O importante √© que um teste n√£o pode falhar por algo que outro teste fez.
>
> üì£ **"Testes automatizados devem ser independentes uns dos outros."**

2. No arquivo `cypress/support/gui_commands.js`, altere o comando customizado de _login_ pelo seguinte:

```js
Cypress.Commands.add('login', (
  user = Cypress.env('user_name'),
  password = Cypress.env('user_password'),
  { cacheSession = true } = {},
) => {
  const login = () => {
    cy.visit('/users/sign_in')

    cy.get("[data-qa-selector='login_field']").type(user)
    cy.get("[data-qa-selector='password_field']").type(password, { log: false })
    cy.get("[data-qa-selector='sign_in_button']").click()
  }

  const validate = () => {
    cy.visit('/')
    cy.location('pathname', { timeout: 1000 })
      .should('not.eq', '/users/sign_in')
  }

  const options = {
    cacheAcrossSpecs: true,
    validate,
  }

  if (cacheSession) {
    cy.session(user, login, options)
  } else {
    login()
  }
})


Cypress.Commands.add('logout', () => {
  ...
})

Cypress.Commands.add('gui_createProject', project => {
  ...
})


```

> üë®‚Äçüè´ Agora, al√©m da possibilidade de compartilhar a sess√£o entre _specs_, tamb√©m estamos habilitando a possibilidade de validar se a mesma ainda √© v√°lida, e caso n√£o seja, a fun√ß√£o de _setup_ (`login`) ser√° executada pelo comando `cy.session`.

3. **Feche a Cypress App**; abra-a de novo com o comando `npx cypress open`; escolha a op√ß√£o _E2E Testing_; e inicialize o navegador Electron

4. Por fim, via Cypress App, execute de novo todos os teste, quantas vezes quiser, e na ordem que quiser. Todos eles devem passar em todas execu√ß√µes, por√©m, dependendo da ordem, um pode se beneficiar da sess√£o criada pelo teste anterior.

</details>

## Mostre ao mundo o que voc√™ aprendeu

Divulgue em sua _timeline_ no LinkedIn o que voc√™ aprendeu nesta aula.

Aqui vai um texto exemplo, caso n√£o tenha uma id√©ia do que escrever.

> **Estou fazendo o curso de [testes automatizados com Cypress (intermedi√°rio)](https://www.udemy.com/course/testes-automatizados-com-cypress-intermediario/?referralCode=F14505FB0076672E51A2) da Escola TAT no Udemy, no qual aprendi a criar testes otimizados com uso da funcionalidade _cy.session_. #TalkingAboutTesting #EscolaTAT #Cypress**

**Observa√ß√£o:** Lembre de me marcar em sua publica√ß√£o.

___

Perfeito!

Agora que a funcionalidade de cria√ß√£o de projeto est√° coberta por testes e o processo de autentica√ß√£o est√° otimizado, v√° para a [aula 5](./5.md) para testarmos a funcionalidade de cria√ß√£o de _issue_.
